<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åˆ†æ - æ™ºèƒ½è®°è´¦æ—¥è®°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2C3E50;
            --secondary-color: #3498DB;
            --accent-color: #27AE60;
            --warning-color: #F39C12;
            --bg-light: #F8F9FA;
        }
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .hover-lift {
            transition: all 0.3s ease;
        }
        
        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
        
        .metric-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
        }
        
        .time-range-btn {
            transition: all 0.2s ease;
        }
        
        .time-range-btn.active {
            background: var(--secondary-color);
            color: white;
            transform: scale(1.05);
        }
        
        .chart-container {
            min-height: 300px;
        }
        
        .scroll-reveal {
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.6s ease;
        }
        
        .scroll-reveal.revealed {
            opacity: 1;
            transform: translateY(0);
        }
        
        .health-score {
            background: conic-gradient(
                from 0deg,
                #ff6b6b 0deg,
                #ffd93d 72deg,
                #6bcf7f 144deg,
                #4ecdc4 216deg,
                #45b7d1 288deg,
                #ff6b6b 360deg
            );
            border-radius: 50%;
            position: relative;
        }
        
        .health-score::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            background: white;
            border-radius: 50%;
        }
        
        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 1s ease;
        }
        
        .budget-item {
            transition: all 0.3s ease;
        }
        
        .budget-item:hover {
            transform: translateX(4px);
        }
    </style>
</head>
<body class="overflow-x-hidden">
    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-50 glass-card">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold gradient-text">ğŸ’° æ™ºèƒ½è®°è´¦</h1>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="index.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-gray-100 transition-colors">é¦–é¡µ</a>
                        <a href="accounting.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-gray-100 transition-colors">è®°è´¦</a>
                        <a href="diary.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-gray-100 transition-colors">æ—¥è®°</a>
                        <a href="analytics.html" class="px-3 py-2 rounded-md text-sm font-medium text-white bg-blue-500">åˆ†æ</a>
                    </div>
                </div>
                <div class="md:hidden">
                    <button id="mobile-menu-btn" class="text-gray-700 hover:text-blue-600">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile menu -->
        <div id="mobile-menu" class="md:hidden hidden">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-white border-t">
                <a href="index.html" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-blue-600">é¦–é¡µ</a>
                <a href="accounting.html" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-blue-600">è®°è´¦</a>
                <a href="diary.html" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-blue-600">æ—¥è®°</a>
                <a href="analytics.html" class="block px-3 py-2 rounded-md text-base font-medium text-white bg-blue-500">åˆ†æ</a>
            </div>
        </div>
    </nav>

    <!-- Header Section -->
    <section class="pt-24 pb-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-8 scroll-reveal">
                <h1 class="text-3xl md:text-4xl font-bold text-white mb-4">æ•°æ®åˆ†æ</h1>
                <p class="text-xl text-gray-200">æ·±åº¦æ´å¯Ÿæ‚¨çš„è´¢åŠ¡çŠ¶å†µ</p>
            </div>
            
            <!-- Time Range Selector -->
            <div class="flex justify-center mb-8 scroll-reveal">
                <div class="glass-card rounded-2xl p-2">
                    <div class="flex space-x-2">
                        <button class="time-range-btn px-6 py-3 rounded-lg font-medium active" data-range="week">æœ¬å‘¨</button>
                        <button class="time-range-btn px-6 py-3 rounded-lg font-medium" data-range="month">æœ¬æœˆ</button>
                        <button class="time-range-btn px-6 py-3 rounded-lg font-medium" data-range="quarter">æœ¬å­£åº¦</button>
                        <button class="time-range-btn px-6 py-3 rounded-lg font-medium" data-range="year">ä»Šå¹´</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Key Metrics -->
    <section class="py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="metric-card rounded-2xl p-6 text-center scroll-reveal">
                    <div class="text-3xl mb-3">ğŸ’°</div>
                    <h3 class="text-lg font-semibold text-white mb-2">æ€»æ”¶å…¥</h3>
                    <p class="text-2xl font-bold text-green-300" id="total-income">Â¥0</p>
                    <p class="text-sm text-gray-300 mt-1" id="income-change">+0% vs ä¸ŠæœŸ</p>
                </div>
                <div class="metric-card rounded-2xl p-6 text-center scroll-reveal">
                    <div class="text-3xl mb-3">ğŸ’¸</div>
                    <h3 class="text-lg font-semibold text-white mb-2">æ€»æ”¯å‡º</h3>
                    <p class="text-2xl font-bold text-red-300" id="total-expense">Â¥0</p>
                    <p class="text-sm text-gray-300 mt-1" id="expense-change">+0% vs ä¸ŠæœŸ</p>
                </div>
                <div class="metric-card rounded-2xl p-6 text-center scroll-reveal">
                    <div class="text-3xl mb-3">ğŸ“Š</div>
                    <h3 class="text-lg font-semibold text-white mb-2">å‡€ç»“ä½™</h3>
                    <p class="text-2xl font-bold text-blue-300" id="net-balance">Â¥0</p>
                    <p class="text-sm text-gray-300 mt-1" id="balance-change">+0% vs ä¸ŠæœŸ</p>
                </div>
                <div class="metric-card rounded-2xl p-6 text-center scroll-reveal">
                    <div class="text-3xl mb-3">ğŸ’</div>
                    <h3 class="text-lg font-semibold text-white mb-2">å‚¨è“„ç‡</h3>
                    <p class="text-2xl font-bold text-purple-300" id="savings-rate">0%</p>
                    <p class="text-sm text-gray-300 mt-1" id="savings-status">è‰¯å¥½</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Charts Section -->
    <section class="py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Expense Breakdown -->
                <div class="glass-card rounded-2xl p-8 scroll-reveal">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-6">æ”¯å‡ºåˆ†å¸ƒ</h3>
                    <div id="expense-pie-chart" class="chart-container"></div>
                </div>

                <!-- Income vs Expense Trend -->
                <div class="glass-card rounded-2xl p-8 scroll-reveal">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-6">æ”¶æ”¯è¶‹åŠ¿</h3>
                    <div id="trend-line-chart" class="chart-container"></div>
                </div>
            </div>

            <div class="glass-card rounded-2xl p-8 scroll-reveal mb-8">
                <h3 class="text-2xl font-semibold text-gray-800 mb-6 text-center">æœˆåº¦å¯¹æ¯”</h3>
                <div id="monthly-bar-chart" class="chart-container"></div>
            </div>
        </div>
    </section>

    <!-- Budget Management -->
    <section class="py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Budget Overview -->
                <div class="glass-card rounded-2xl p-8 scroll-reveal">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-6">é¢„ç®—ç®¡ç†</h3>
                    <div id="budget-overview" class="space-y-4">
                        <!-- Budget items will be populated by JavaScript -->
                    </div>
                    <button onclick="showBudgetModal()" class="w-full mt-6 bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors">
                        è®¾ç½®é¢„ç®—
                    </button>
                </div>

                <!-- Financial Health Score -->
                <div class="glass-card rounded-2xl p-8 scroll-reveal">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-6 text-center">è´¢åŠ¡å¥åº·è¯„åˆ†</h3>
                    <div class="flex justify-center mb-6">
                        <div class="health-score w-32 h-32 flex items-center justify-center">
                            <div class="text-center z-10">
                                <div class="text-3xl font-bold text-gray-800" id="health-score">85</div>
                                <div class="text-sm text-gray-600">åˆ†</div>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span>å‚¨è“„èƒ½åŠ›</span>
                                <span id="savings-ability">è‰¯å¥½</span>
                            </div>
                            <div class="progress-bar h-2">
                                <div class="progress-fill bg-green-500" id="savings-progress" style="width: 75%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span>æ”¯å‡ºæ§åˆ¶</span>
                                <span id="expense-control">ä¼˜ç§€</span>
                            </div>
                            <div class="progress-bar h-2">
                                <div class="progress-fill bg-blue-500" id="expense-progress" style="width: 85%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span>æ”¶å…¥ç¨³å®š</span>
                                <span id="income-stability">ç¨³å®š</span>
                            </div>
                            <div class="progress-bar h-2">
                                <div class="progress-fill bg-purple-500" id="income-progress" style="width: 90%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-semibold text-blue-800 mb-2">ğŸ’¡ å»ºè®®</h4>
                        <p class="text-sm text-blue-700" id="health-advice">
                            æ‚¨çš„è´¢åŠ¡çŠ¶å†µè‰¯å¥½ï¼Œå»ºè®®ç»§ç»­ä¿æŒå½“å‰çš„å‚¨è“„ä¹ æƒ¯ï¼Œå¹¶è€ƒè™‘é€‚å½“å¢åŠ æŠ•èµ„æ¯”ä¾‹ã€‚
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="py-8 border-t border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <p class="text-gray-300">&copy; 2026 æ™ºèƒ½è®°è´¦æ—¥è®°. è®©è´¢åŠ¡ç®¡ç†å˜å¾—ç®€å•ã€æ™ºèƒ½ã€æœ‰è¶£.</p>
            </div>
        </div>
    </footer>

    <!-- Budget Setting Modal -->
    <div id="budget-modal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full transform scale-95 transition-transform">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">è®¾ç½®é¢„ç®—</h3>
                    <button onclick="closeBudgetModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†ç±»</label>
                        <select id="budget-category" class="w-full py-2 px-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="food">ğŸ½ï¸ é¤é¥®</option>
                            <option value="transport">ğŸš— äº¤é€š</option>
                            <option value="shopping">ğŸ›ï¸ è´­ç‰©</option>
                            <option value="entertainment">ğŸ¬ å¨±ä¹</option>
                            <option value="health">ğŸ¥ åŒ»ç–—</option>
                            <option value="education">ğŸ“š æ•™è‚²</option>
                            <option value="housing">ğŸ  å±…ä½</option>
                            <option value="other">ğŸ“ å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æœˆåº¦é¢„ç®—é‡‘é¢</label>
                        <input type="number" id="budget-amount" step="0.01" 
                               class="w-full py-2 px-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="è¯·è¾“å…¥é‡‘é¢">
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button onclick="saveBudget()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors">
                            ä¿å­˜é¢„ç®—
                        </button>
                        <button onclick="closeBudgetModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="fixed top-20 right-4 z-50 transform translate-x-full transition-transform duration-300">
        <div class="bg-white rounded-lg shadow-lg p-4 min-w-80">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <p id="notification-text" class="text-sm font-medium text-gray-900"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Analytics Page JavaScript
        let allTransactions = [];
        let allDiaries = [];
        let currentTimeRange = 'week';
        let expensePieChart = null;
        let trendLineChart = null;
        let monthlyBarChart = null;
        let budgets = JSON.parse(localStorage.getItem('budgets') || '{}');

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        function initializePage() {
            setupMobileMenu();
            setupScrollReveal();
            loadData();
            setupTimeRangeSelector();
            updateAnalytics();
            initializeCharts();
            renderBudgetOverview();
            updateHealthScore();
        }

        // Mobile menu setup
        function setupMobileMenu() {
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            
            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                });
            }
        }

        // Scroll reveal animation
        function setupScrollReveal() {
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('revealed');
                    }
                });
            }, observerOptions);
            
            document.querySelectorAll('.scroll-reveal').forEach(el => {
                observer.observe(el);
            });
        }

        // Load data from localStorage
        function loadData() {
            const transactionsStored = localStorage.getItem('transactions');
            const diariesStored = localStorage.getItem('diaries');
            
            allTransactions = transactionsStored ? JSON.parse(transactionsStored) : [];
            allDiaries = diariesStored ? JSON.parse(diariesStored) : [];
        }

        // Setup time range selector
        function setupTimeRangeSelector() {
            const rangeButtons = document.querySelectorAll('.time-range-btn');
            
            rangeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    rangeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentTimeRange = btn.getAttribute('data-range');
                    updateAnalytics();
                    updateCharts();
                });
            });
        }

        // Get filtered transactions based on time range
        function getFilteredTransactions() {
            const now = new Date();
            let startDate;
            
            switch (currentTimeRange) {
                case 'week':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - now.getDay());
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                default:
                    startDate = new Date(0);
            }
            
            return allTransactions.filter(t => new Date(t.date) >= startDate);
        }

        // Update analytics
        function updateAnalytics() {
            const transactions = getFilteredTransactions();
            const previousPeriodTransactions = getPreviousPeriodTransactions();
            
            let totalIncome = 0;
            let totalExpense = 0;
            let previousIncome = 0;
            let previousExpense = 0;
            
            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else {
                    totalExpense += t.amount;
                }
            });
            
            previousPeriodTransactions.forEach(t => {
                if (t.type === 'income') {
                    previousIncome += t.amount;
                } else {
                    previousExpense += t.amount;
                }
            });
            
            const netBalance = totalIncome - totalExpense;
            const previousBalance = previousIncome - previousExpense;
            
            const savingsRate = totalIncome > 0 ? (netBalance / totalIncome * 100) : 0;
            
            // Update display with animation
            animateNumber('total-income', totalIncome, 'Â¥');
            animateNumber('total-expense', totalExpense, 'Â¥');
            animateNumber('net-balance', netBalance, 'Â¥');
            animateNumber('savings-rate', savingsRate, '', '%');
            
            // Update change percentages
            updateChangePercentage('income-change', totalIncome, previousIncome);
            updateChangePercentage('expense-change', totalExpense, previousExpense);
            updateChangePercentage('balance-change', netBalance, previousBalance);
            
            // Update savings status
            const savingsStatus = document.getElementById('savings-status');
            if (savingsRate >= 30) {
                savingsStatus.textContent = 'ä¼˜ç§€';
                savingsStatus.className = 'text-sm text-green-300 mt-1';
            } else if (savingsRate >= 20) {
                savingsStatus.textContent = 'è‰¯å¥½';
                savingsStatus.className = 'text-sm text-blue-300 mt-1';
            } else if (savingsRate >= 10) {
                savingsStatus.textContent = 'ä¸€èˆ¬';
                savingsStatus.className = 'text-sm text-yellow-300 mt-1';
            } else {
                savingsStatus.textContent = 'éœ€æ”¹å–„';
                savingsStatus.className = 'text-sm text-red-300 mt-1';
            }
        }

        // Get previous period transactions for comparison
        function getPreviousPeriodTransactions() {
            const now = new Date();
            let currentStart, previousStart, previousEnd;
            
            switch (currentTimeRange) {
                case 'week':
                    currentStart = new Date(now);
                    currentStart.setDate(now.getDate() - now.getDay());
                    previousStart = new Date(currentStart);
                    previousStart.setDate(currentStart.getDate() - 7);
                    previousEnd = new Date(currentStart);
                    break;
                case 'month':
                    currentStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    previousStart = new Date(currentStart);
                    previousStart.setMonth(currentStart.getMonth() - 1);
                    previousEnd = new Date(currentStart);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    currentStart = new Date(now.getFullYear(), quarter * 3, 1);
                    previousStart = new Date(currentStart);
                    previousStart.setMonth(currentStart.getMonth() - 3);
                    previousEnd = new Date(currentStart);
                    break;
                case 'year':
                    currentStart = new Date(now.getFullYear(), 0, 1);
                    previousStart = new Date(currentStart);
                    previousStart.setFullYear(currentStart.getFullYear() - 1);
                    previousEnd = new Date(currentStart);
                    break;
                default:
                    return [];
            }
            
            return allTransactions.filter(t => {
                const date = new Date(t.date);
                return date >= previousStart && date < previousEnd;
            });
        }

        // Animate number changes
        function animateNumber(elementId, targetValue, prefix = '', suffix = '') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const startValue = parseFloat(element.textContent.replace(/[Â¥%,]/g, '')) || 0;
            
            anime({
                targets: { value: startValue },
                value: targetValue,
                duration: 1000,
                easing: 'easeOutQuad',
                update: function(anim) {
                    const currentValue = anim.animatables[0].target.value;
                    element.textContent = prefix + currentValue.toFixed(2) + suffix;
                }
            });
        }

        // Update change percentage
        function updateChangePercentage(elementId, current, previous) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (previous === 0) {
                element.textContent = current > 0 ? '+100%' : '0%';
                element.className = 'text-sm text-green-300 mt-1';
                return;
            }
            
            const change = ((current - previous) / previous * 100);
            const sign = change >= 0 ? '+' : '';
            
            element.textContent = sign + change.toFixed(1) + '% vs ä¸ŠæœŸ';
            
            if (elementId === 'income-change') {
                element.className = change >= 0 ? 'text-sm text-green-300 mt-1' : 'text-sm text-red-300 mt-1';
            } else if (elementId === 'expense-change') {
                element.className = change <= 0 ? 'text-sm text-green-300 mt-1' : 'text-sm text-red-300 mt-1';
            } else {
                element.className = change >= 0 ? 'text-sm text-green-300 mt-1' : 'text-sm text-red-300 mt-1';
            }
        }

        // Initialize charts
        function initializeCharts() {
            initializeExpensePieChart();
            initializeTrendLineChart();
            initializeMonthlyBarChart();
        }

        // Initialize expense pie chart
        function initializeExpensePieChart() {
            const chartContainer = document.getElementById('expense-pie-chart');
            if (!chartContainer) return;
            
            expensePieChart = echarts.init(chartContainer);
            updateExpensePieChart();
        }

        // Update expense pie chart
        function updateExpensePieChart() {
            if (!expensePieChart) return;
            
            const transactions = getFilteredTransactions();
            const expenseTransactions = transactions.filter(t => t.type === 'expense');
            
            const categoryStats = {};
            expenseTransactions.forEach(t => {
                const key = t.categoryName;
                categoryStats[key] = (categoryStats[key] || 0) + t.amount;
            });
            
            const data = Object.entries(categoryStats).map(([name, value]) => ({
                name: name,
                value: value
            }));
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: Â¥{c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    right: '5%',
                    top: 'center',
                    textStyle: {
                        color: '#666'
                    }
                },
                series: [{
                    name: 'æ”¯å‡ºåˆ†å¸ƒ',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['40%', '50%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 8,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: false,
                        position: 'center'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: '16',
                            fontWeight: 'bold'
                        }
                    },
                    labelLine: {
                        show: false
                    },
                    data: data.length > 0 ? data : [
                        { name: 'æš‚æ— æ•°æ®', value: 1, itemStyle: { color: '#E0E0E0' } }
                    ],
                    color: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F']
                }]
            };
            
            expensePieChart.setOption(option);
        }

        // Initialize trend line chart
        function initializeTrendLineChart() {
            const chartContainer = document.getElementById('trend-line-chart');
            if (!chartContainer) return;
            
            trendLineChart = echarts.init(chartContainer);
            updateTrendLineChart();
        }

        // Update trend line chart
        function updateTrendLineChart() {
            if (!trendLineChart) return;
            
            const transactions = getFilteredTransactions();
            const dates = getDateRange();
            
            const incomeData = [];
            const expenseData = [];
            
            dates.forEach(date => {
                const dayTransactions = transactions.filter(t => t.date === date.toISOString().split('T')[0]);
                
                const dayIncome = dayTransactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const dayExpense = dayTransactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                incomeData.push(dayIncome);
                expenseData.push(dayExpense);
            });
            
            const dateLabels = dates.map(date => {
                if (currentTimeRange === 'week') {
                    return ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'][date.getDay()];
                } else {
                    return date.getDate().toString();
                }
            });
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                legend: {
                    data: ['æ”¶å…¥', 'æ”¯å‡º'],
                    textStyle: {
                        color: '#666'
                    }
                },
                xAxis: {
                    type: 'category',
                    data: dateLabels,
                    axisLine: {
                        lineStyle: {
                            color: '#666'
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLine: {
                        lineStyle: {
                            color: '#666'
                        }
                    }
                },
                series: [
                    {
                        name: 'æ”¶å…¥',
                        type: 'line',
                        data: incomeData,
                        smooth: true,
                        lineStyle: {
                            color: '#27AE60',
                            width: 3
                        },
                        itemStyle: {
                            color: '#27AE60'
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(39, 174, 96, 0.3)' },
                                    { offset: 1, color: 'rgba(39, 174, 96, 0.1)' }
                                ]
                            }
                        }
                    },
                    {
                        name: 'æ”¯å‡º',
                        type: 'line',
                        data: expenseData,
                        smooth: true,
                        lineStyle: {
                            color: '#E74C3C',
                            width: 3
                        },
                        itemStyle: {
                            color: '#E74C3C'
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(231, 76, 60, 0.3)' },
                                    { offset: 1, color: 'rgba(231, 76, 60, 0.1)' }
                                ]
                            }
                        }
                    }
                ]
            };
            
            trendLineChart.setOption(option);
        }

        // Initialize monthly bar chart
        function initializeMonthlyBarChart() {
            const chartContainer = document.getElementById('monthly-bar-chart');
            if (!chartContainer) return;
            
            monthlyBarChart = echarts.init(chartContainer);
            updateMonthlyBarChart();
        }

        // Update monthly bar chart
        function updateMonthlyBarChart() {
            if (!monthlyBarChart) return;
            
            const months = [];
            const incomeData = [];
            const expenseData = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                
                const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
                const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);
                
                const monthTransactions = allTransactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate >= monthStart && transactionDate <= monthEnd;
                });
                
                const monthIncome = monthTransactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const monthExpense = monthTransactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                months.push(date.getMonth() + 1 + 'æœˆ');
                incomeData.push(monthIncome);
                expenseData.push(monthExpense);
            }
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: ['æ”¶å…¥', 'æ”¯å‡º'],
                    textStyle: {
                        color: '#666'
                    }
                },
                xAxis: {
                    type: 'category',
                    data: months,
                    axisLine: {
                        lineStyle: {
                            color: '#666'
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLine: {
                        lineStyle: {
                            color: '#666'
                        }
                    }
                },
                series: [
                    {
                        name: 'æ”¶å…¥',
                        type: 'bar',
                        data: incomeData,
                        itemStyle: {
                            color: '#27AE60',
                            borderRadius: [4, 4, 0, 0]
                        }
                    },
                    {
                        name: 'æ”¯å‡º',
                        type: 'bar',
                        data: expenseData,
                        itemStyle: {
                            color: '#E74C3C',
                            borderRadius: [4, 4, 0, 0]
                        }
                    }
                ]
            };
            
            monthlyBarChart.setOption(option);
        }

        // Get date range for current time range
        function getDateRange() {
            const dates = [];
            const now = new Date();
            let days;
            
            switch (currentTimeRange) {
                case 'week':
                    days = 7;
                    break;
                case 'month':
                    days = 30;
                    break;
                case 'quarter':
                    days = 90;
                    break;
                case 'year':
                    days = 365;
                    break;
                default:
                    days = 7;
            }
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                dates.push(date);
            }
            
            return dates;
        }

        // Update all charts
        function updateCharts() {
            updateExpensePieChart();
            updateTrendLineChart();
            updateMonthlyBarChart();
        }

        // Render budget overview
        function renderBudgetOverview() {
            const container = document.getElementById('budget-overview');
            if (!container) return;
            
            const transactions = getFilteredTransactions();
            const expenseTransactions = transactions.filter(t => t.type === 'expense');
            
            const categoryStats = {};
            expenseTransactions.forEach(t => {
                const key = t.category;
                categoryStats[key] = (categoryStats[key] || 0) + t.amount;
            });
            
            const categoryNames = {
                food: { name: 'é¤é¥®', icon: 'ğŸ½ï¸' },
                transport: { name: 'äº¤é€š', icon: 'ğŸš—' },
                shopping: { name: 'è´­ç‰©', icon: 'ğŸ›ï¸' },
                entertainment: { name: 'å¨±ä¹', icon: 'ğŸ¬' },
                health: { name: 'åŒ»ç–—', icon: 'ğŸ¥' },
                education: { name: 'æ•™è‚²', icon: 'ğŸ“š' },
                housing: { name: 'å±…ä½', icon: 'ğŸ ' },
                other: { name: 'å…¶ä»–', icon: 'ğŸ“' }
            };
            
            let budgetHTML = '';
            
            Object.entries(budgets).forEach(([category, amount]) => {
                const spent = categoryStats[category] || 0;
                const percentage = amount > 0 ? (spent / amount * 100) : 0;
                const remaining = Math.max(0, amount - spent);
                
                const categoryInfo = categoryNames[category] || { name: category, icon: 'ğŸ“' };
                
                budgetHTML += `
                    <div class="budget-item p-4 bg-white rounded-lg border border-gray-100">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center">
                                <span class="text-xl mr-3">${categoryInfo.icon}</span>
                                <span class="font-medium text-gray-800">${categoryInfo.name}</span>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-600">Â¥${spent.toFixed(2)} / Â¥${amount.toFixed(2)}</div>
                            </div>
                        </div>
                        <div class="progress-bar h-3 mb-2">
                            <div class="progress-fill ${percentage > 90 ? 'bg-red-500' : percentage > 70 ? 'bg-yellow-500' : 'bg-green-500'}" 
                                 style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>${percentage.toFixed(1)}% å·²ä½¿ç”¨</span>
                            <span>å‰©ä½™ Â¥${remaining.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            });
            
            if (Object.keys(budgets).length === 0) {
                budgetHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <p>æš‚æ— é¢„ç®—è®¾ç½®</p>
                        <p class="text-sm mt-2">ç‚¹å‡»"è®¾ç½®é¢„ç®—"å¼€å§‹ç®¡ç†æ‚¨çš„æ”¯å‡º</p>
                    </div>
                `;
            }
            
            container.innerHTML = budgetHTML;
        }

        // Update health score
        function updateHealthScore() {
            const transactions = getFilteredTransactions();
            const expenseTransactions = transactions.filter(t => t.type === 'expense');
            const incomeTransactions = transactions.filter(t => t.type === 'income');
            
            const totalIncome = incomeTransactions.reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = expenseTransactions.reduce((sum, t) => sum + t.amount, 0);
            
            // Calculate various metrics
            const savingsRate = totalIncome > 0 ? ((totalIncome - totalExpense) / totalIncome) : 0;
            const budgetAdherence = calculateBudgetAdherence(expenseTransactions);
            const incomeStability = calculateIncomeStability();
            
            // Calculate overall health score
            const savingsScore = Math.min(savingsRate * 200, 100); // Max 100 at 50% savings rate
            const budgetScore = budgetAdherence * 100;
            const stabilityScore = incomeStability * 100;
            
            const overallScore = (savingsScore + budgetScore + stabilityScore) / 3;
            
            // Update display
            animateNumber('health-score', overallScore, '', 'åˆ†');
            
            // Update progress bars
            updateProgressBar('savings-progress', savingsScore);
            updateProgressBar('expense-progress', budgetScore);
            updateProgressBar('income-progress', stabilityScore);
            
            // Update status texts
            updateStatusText('savings-ability', savingsScore);
            updateStatusText('expense-control', budgetScore);
            updateStatusText('income-stability', stabilityScore);
            
            // Update advice
            updateHealthAdvice(overallScore, savingsRate, budgetAdherence);
        }

        // Calculate budget adherence
        function calculateBudgetAdherence(expenseTransactions) {
            if (Object.keys(budgets).length === 0) return 1;
            
            const categoryStats = {};
            expenseTransactions.forEach(t => {
                const key = t.category;
                categoryStats[key] = (categoryStats[key] || 0) + t.amount;
            });
            
            let totalAdherence = 0;
            let budgetCount = 0;
            
            Object.entries(budgets).forEach(([category, budget]) => {
                const spent = categoryStats[category] || 0;
                const adherence = spent <= budget ? 1 : (budget / spent);
                totalAdherence += adherence;
                budgetCount++;
            });
            
            return budgetCount > 0 ? totalAdherence / budgetCount : 1;
        }

        // Calculate income stability
        function calculateIncomeStability() {
            const incomeTransactions = allTransactions.filter(t => t.type === 'income');
            
            if (incomeTransactions.length === 0) return 0.5;
            
            // Simple stability check based on regularity
            const monthlyIncome = {};
            incomeTransactions.forEach(t => {
                const date = new Date(t.date);
                const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                monthlyIncome[monthKey] = (monthlyIncome[monthKey] || 0) + t.amount;
            });
            
            const monthlyAmounts = Object.values(monthlyIncome);
            if (monthlyAmounts.length < 2) return 0.7;
            
            const avgIncome = monthlyAmounts.reduce((sum, amount) => sum + amount, 0) / monthlyAmounts.length;
            const variance = monthlyAmounts.reduce((sum, amount) => sum + Math.pow(amount - avgIncome, 2), 0) / monthlyAmounts.length;
            const stability = 1 / (1 + Math.sqrt(variance) / avgIncome);
            
            return Math.min(stability, 1);
        }

        // Update progress bar
        function updateProgressBar(elementId, percentage) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            anime({
                targets: element,
                width: percentage + '%',
                duration: 1000,
                easing: 'easeOutQuad'
            });
        }

        // Update status text
        function updateStatusText(elementId, score) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            let status;
            if (score >= 80) {
                status = 'ä¼˜ç§€';
                element.className = 'text-sm text-green-600';
            } else if (score >= 60) {
                status = 'è‰¯å¥½';
                element.className = 'text-sm text-blue-600';
            } else if (score >= 40) {
                status = 'ä¸€èˆ¬';
                element.className = 'text-sm text-yellow-600';
            } else {
                status = 'éœ€æ”¹å–„';
                element.className = 'text-sm text-red-600';
            }
            
            element.textContent = status;
        }

        // Update health advice
        function updateHealthAdvice(overallScore, savingsRate, budgetAdherence) {
            const adviceElement = document.getElementById('health-advice');
            if (!adviceElement) return;
            
            let advice;
            
            if (overallScore >= 80) {
                advice = 'æ‚¨çš„è´¢åŠ¡çŠ¶å†µéå¸¸å¥åº·ï¼ç»§ç»­ä¿æŒè‰¯å¥½çš„å‚¨è“„ä¹ æƒ¯ï¼Œå¯ä»¥è€ƒè™‘å¢åŠ æŠ•èµ„æ¯”ä¾‹ã€‚';
            } else if (overallScore >= 60) {
                advice = 'æ‚¨çš„è´¢åŠ¡çŠ¶å†µè‰¯å¥½ï¼Œå»ºè®®ç»§ç»­ä¿æŒã€‚å¯ä»¥è€ƒè™‘ä¼˜åŒ–æ”¯å‡ºç»“æ„ï¼Œå¢åŠ å‚¨è“„ã€‚';
            } else if (overallScore >= 40) {
                advice = 'æ‚¨çš„è´¢åŠ¡çŠ¶å†µéœ€è¦å…³æ³¨ã€‚å»ºè®®åˆ¶å®šè¯¦ç»†çš„é¢„ç®—è®¡åˆ’ï¼Œæ§åˆ¶éå¿…è¦æ”¯å‡ºã€‚';
            } else {
                advice = 'æ‚¨çš„è´¢åŠ¡çŠ¶å†µéœ€è¦ç«‹å³æ”¹å–„ã€‚å»ºè®®é‡æ–°å®¡è§†æ”¯å‡ºç»“æ„ï¼Œå»ºç«‹ç´§æ€¥å‚¨å¤‡é‡‘ã€‚';
            }
            
            if (savingsRate < 20) {
                advice += ' å»ºè®®å°†å‚¨è“„ç‡æå‡è‡³20%ä»¥ä¸Šã€‚';
            }
            
            if (budgetAdherence < 0.8) {
                advice += ' æ³¨æ„æ§åˆ¶é¢„ç®—æ”¯å‡ºã€‚';
            }
            
            adviceElement.textContent = advice;
        }

        // Budget modal functions
        function showBudgetModal() {
            const modal = document.getElementById('budget-modal');
            if (modal) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.querySelector('.bg-white').style.transform = 'scale(1)';
                }, 10);
            }
        }

        function closeBudgetModal() {
            const modal = document.getElementById('budget-modal');
            if (modal) {
                modal.querySelector('.bg-white').style.transform = 'scale(0.95)';
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 200);
            }
        }

        function saveBudget() {
            const category = document.getElementById('budget-category').value;
            const amount = parseFloat(document.getElementById('budget-amount').value);
            
            if (!amount || amount <= 0) {
                showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„é¢„ç®—é‡‘é¢', 'error');
                return;
            }
            
            budgets[category] = amount;
            localStorage.setItem('budgets', JSON.stringify(budgets));
            
            renderBudgetOverview();
            updateHealthScore();
            closeBudgetModal();
            
            showNotification('é¢„ç®—è®¾ç½®æˆåŠŸï¼', 'success');
        }

        // Utility functions
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            
            if (notification && notificationText) {
                notificationText.textContent = message;
                notification.style.transform = 'translateX(0)';
                
                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                }, 3000);
            }
        }

        // Resize charts on window resize
        window.addEventListener('resize', () => {
            if (expensePieChart) expensePieChart.resize();
            if (trendLineChart) trendLineChart.resize();
            if (monthlyBarChart) monthlyBarChart.resize();
        });
    </script>
</body>
</html>